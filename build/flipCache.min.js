(function(){angular.module("flipCache",[]).factory("flipCache",["$http","$q","$rootScope",function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n;return j=console.log,h=function(a,b){return null==a&&(a={}),null==b&&(b={}),JSON.stringify({query:a,options:b})},g=function(a){return null==a&&(a={}),JSON.stringify(a)},i=function(a){return null==a&&(a={}),1===Object.keys(a).length&&"_id"===Object.keys(a)[0]&&"number"==typeof a._id},f=function(a){return Math.floor(Math.random()*a)},e=function(a){var b,c,d,f;if("object"!=typeof a)return a;if(null===a)return a;if(a instanceof Array)return function(){var b,c,d;for(d=[],b=0,c=a.length;c>b;b++)f=a[b],d.push(e(f));return d}();c={};for(b in a)d=a[b],d instanceof Date?(c[b]=e(d),c[b].__proto__=d.proto):c[b]=e(d);return c},l=function(c,d,e){return b(function(b,f){var g,h;return h="/api/"+c,g={},Object.keys(d).length>0&&(g.q=JSON.stringify(d)),Object.keys(e).length>0&&(g.fields=JSON.stringify(e)),a({method:"GET",url:h,params:g}).success(function(a,c,d,e){return angular.isDefined(a._status)&&"OK"===a._status&&angular.isDefined(a._items)?b(a):f(a)}).error(function(a,b,c,d){return f({_status:"ERR",_msg:"Server returned code "+b})})})},m=function(c,d){return b(function(b,e){var f;return f="/api/"+c,a({method:"POST",url:f,data:d}).success(function(a,c,d,f){return angular.isDefined(a._status)&&"OK"===a._status&&angular.isDefined(a._item)?b(a):e(a)}).error(function(a,b,c,d){return e({_status:"ERR",_msg:"Server returned code "+b})})})},n=function(c,d){return b(function(b,e){var f;return f="/api/"+c+"/"+d._id,a({method:"PUT",url:f,data:d}).success(function(a,c,d,f){return angular.isDefined(a._status)&&"OK"===a._status&&angular.isDefined(a._item)?b(a):e(a)}).error(function(a,b,c,d){return e({_status:"ERR",_msg:"Server returned code "+b})})})},k=function(c,d){return b(function(b,e){var f;return f="/api/"+c+"/"+d._id,a({method:"DELETE",url:f}).success(function(a,c,d,f){return angular.isDefined(a._status)&&"OK"===a._status?b():e(a)}).error(function(a,b,c,d){return e({_status:"ERR",_msg:"Server returned code "+b})})})},new(d=function(){function a(){var a;this._listCache={},this._docCache={},this._actives=[],this._tids=[],a=Primus.connect(),a.on("data",function(a){return function(b){switch(b.action){case"create":a._resetList(b.collection);break;case"delete":a._resetList(b.collection);break;case"edit":a._resetDoc(b.collection,b.id)}return c.$broadcast("socketEvent",b)}}(this))}return a.prototype._setupCache=function(a){return a in this._listCache||(this._listCache[a]={}),a in this._docCache?void 0:this._docCache[a]={}},a.prototype._isCached=function(a,b,c,d){var e,f;return this._setupCache(a),i(b)?(e=g(d),b._id in this._docCache[a]&&this._docCache[a][b._id].valid&&e in this._docCache[a][b._id]):(f=h(b,c),e=g(d),f in this._listCache[a]&&this._listCache[a][f].valid&&this._listCache[a][f].docs.every(function(a){return a.valid&&e in a}))},a.prototype._getList=function(a,b,c,d){var f,j,k;return this._setupCache(a),i(b)?(f=g(d),[this._getDoc(a,b,d)]):(j=h(b,c),f=g(d),e(function(){var b,c,d,e;for(d=this._listCache[a][j].docs,e=[],b=0,c=d.length;c>b;b++)k=d[b],e.push(k[f]);return e}.call(this)))},a.prototype._getDoc=function(a,b,c){var d;return d=g(c),e(this._docCache[a][b._id][d])},a.prototype._cacheList=function(a,b,c,d,e){var f,j;return this._setupCache(a),i(b)?this._cacheDoc(a,e[0],d):(j=h(b,c),f=g(d),j in this._listCache[a]||(this._listCache[a][j]={}),this._listCache[a][j].valid=!0,this._listCache[a][j].docs=[],e.forEach(function(b){return function(c){return b._listCache[a][j].docs.push(b._cacheDoc(a,c,d))}}(this)))},a.prototype._cacheDoc=function(a,b,c){var d;return d=g(c),b._id in this._docCache[a]||(this._docCache[a][b._id]={}),this._docCache[a][b._id].valid=!0,this._docCache[a][b._id][d]=b,this._docCache[a][b._id]},a.prototype._resetList=function(a){return this.invalidateLists(a),this._actives.forEach(function(b){return"collection"in b&&b.collection===a?b.$get():void 0})},a.prototype._resetDoc=function(a,b){return this.invalidateDoc(a,b),this._actives.forEach(function(c){return"_collection"in c&&c._collection===a&&c._id===b?c.$get():void 0})},a.prototype.invalidateDoc=function(a,b){return this._setupCache(a),b in this._docCache[a]?this._docCache[a][b].valid=!1:void 0},a.prototype.invalidateLists=function(a){var b,c,d,e;this._setupCache(a),c=this._listCache[a],d=[];for(b in c)e=c[b],d.push(e.valid=!1);return d},a.prototype.find=function(a,c,d,e){var f;return null==c&&(c={}),null==d&&(d={}),null==e&&(e={}),f=this._isCached(a,c,d,e)?b(function(a){return a()}):l(a,c,e).then(function(b){return function(f){return b._cacheList(a,c,d,e,f._items)}}(this))["catch"](function(a){throw a}),f.then(function(b){return function(){return b._getList(a,c,d,e)}}(this))},a.prototype.findOne=function(a,c,d,e){var f;return null==c&&(c={}),null==d&&(d={}),null==e&&(e={}),f=this._isCached(a,c,d,e)?b(function(a){return a()}):l(a,c,e).then(function(b){return function(f){return b._cacheList(a,c,d,e,f._items)}}(this))["catch"](function(a){throw a}),f.then(function(b){return function(){return b._getList(a,c,d,e)[0]}}(this))},a.prototype.insert=function(a,b){return this._setupCache(a),b._tid=f(1e9),this._tids.push(b._tid),m(a,b).then(function(c){return function(d){return delete b._tid,c._cacheDoc(a,d._item),d._item}}(this))["catch"](function(a){throw a})},a.prototype.update=function(a,b){return this._setupCache(a),b._tid=f(1e9),this._tids.push(b._tid),n(a,b).then(function(c){return function(d){return delete b._tid,c._cacheDoc(a,d._item),d._item}}(this))["catch"](function(a){throw a})},a.prototype.remove=function(a,b){return this._setupCache(a),k(a,b).then(function(c){return function(d){return c.invalidateDoc(a,b._id),null}}(this))["catch"](function(a){throw a})},a.prototype.setActive=function(a){return this.clearActives(),this.addActive(a)},a.prototype.addActive=function(a){var b,c,d,e;for(e=this._actives,c=0,d=e.length;d>c;c++)if(b=e[c],b===a)return;return this._actives.push(a)},a.prototype.clearActives=function(){return this._actives.splice(0)},a}())}])}).call(this),function(){angular.module("flipDoc",["flipCache"]).factory("flipDoc",["$q","flipCache",function(a,b){var c,d;return c=function(){function c(a,b){this._id=null,"object"==typeof a?this._extend(a):(this._collection=a,"object"==typeof b?this._extend(b):this._id=b)}return c.prototype._extend=function(a){var b,c,d;c=[];for(b in a)d=a[b],angular.isFunction(d)?c.push(void 0):c.push(this[b]=d);return c},c.prototype._clear=function(){var a,b,c;b=[];for(a in this)c=this[a],angular.isFunction(c)?b.push(void 0):b.push(this[a]=null);return b},c.prototype.$get=function(){return a(function(a){return function(c,d){return b.findOne(a._collection,{_id:a._id}).then(function(b){return a._extend(b),c(a)})["catch"](function(a){return d(a)})}}(this))},c.prototype.$save=function(){return a(function(a){return function(c,d){return a._id?b.update(a._collection,a).then(function(b){return a._extend(b),c(a)})["catch"](function(a){return d(a)}):b.insert(a._collection,a).then(function(b){return a._extend(b),c(a)})["catch"](function(a){return d(a)})}}(this))},c.prototype.$delete=function(){return a(function(a){return function(c,d){return b.remove(a._collection,a).then(function(b){return a._clear(),c()})["catch"](function(a){return d(a)})}}(this))},c.prototype.$setActive=function(){return b.setActive(this)},c.prototype.$addActive=function(){return b.addActive(this)},c}(),d=function(a,b){return new c(a,b)},d.clearActives=function(){return b.clearActives()},d}])}.call(this),function(){angular.module("flipList",["flipCache","flipDoc"]).factory("flipList",["$q","flipCache","flipDoc",function(a,b,c){var d;return d=function(d){var e;return e=[],e.collection=d.collection,e.filter=d.filter||{},e.options=d.options||{},e.fields=d.fields||{},e.$get=function(){return a(function(a,d){return b.find(e.collection,e.filter,e.options,e.fields).then(function(b){var d,f,g;for(e.splice(0,e.length),d=0,f=b.length;f>d;d++)g=b[d],e.push(c(e.collection,g));return a(e)})["catch"](function(a){return d(a)})})},e.$setActive=function(){return b.setActive(e)},e.$addActive=function(){return b.addActive(e)},e},d.$clearActives=function(){return b.clearActives()},d}])}.call(this);