(function(){var a=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};angular.module("flipCache",[]).factory("flipCache",["$http","$q","$rootScope",function(b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p;return l=console.log,f=null,j=function(a,b){var c;return null==a&&(a={}),null==b&&(b={}),c=angular.copy(b),delete c.fields,JSON.stringify({query:a,options:c})},i=function(a){return null==a&&(a={}),JSON.stringify(a)},k=function(a){return null==a&&(a={}),1===Object.keys(a).length&&"_id"===Object.keys(a)[0]&&"number"==typeof a._id},h=function(a){return Math.floor(Math.random()*a)},g=function(a){var b,c,d,e;if("object"!=typeof a)return a;if(null===a)return a;if(a instanceof Array)return function(){var b,c,d;for(d=[],b=0,c=a.length;c>b;b++)e=a[b],d.push(g(e));return d}();c={};for(b in a)d=a[b],d instanceof Date?(c[b]=g(d),c[b].__proto__=d.proto):c[b]=g(d);return c},n=function(a,d,e){return c(function(c,g){var h,i;return i=f.apiRoot+("/"+a),h={},Object.keys(d).length>0&&(h.q=JSON.stringify(d)),"fields"in e&&Object.keys(e.fields).length>0&&(h.fields=JSON.stringify(e.fields)),"sort"in e&&Object.keys(e.sort).length>0&&(h.sort=JSON.stringify(e.sort)),b({method:"GET",url:i,params:h}).success(function(a,b,d,e){return angular.isDefined(a._status)&&"OK"===a._status&&angular.isDefined(a._items)?c(a):g(a)}).error(function(a,b,c,d){return g({_status:"ERR",_msg:"Server returned code "+b})})})},o=function(a,d){return c(function(c,e){var g;return g=f.apiRoot+("/"+a),b({method:"POST",url:g,data:d}).success(function(a,b,d,f){return angular.isDefined(a._status)&&"OK"===a._status&&angular.isDefined(a._item)?c(a):e(a)}).error(function(a,b,c,d){return e({_status:"ERR",_msg:"Server returned code "+b})})})},p=function(a,d){return c(function(c,e){var g;return g=f.apiRoot+("/"+a+"/"+d._id),b({method:"PUT",url:g,data:d}).success(function(a,b,d,f){return angular.isDefined(a._status)&&"OK"===a._status&&angular.isDefined(a._item)?c(a):e(a)}).error(function(a,b,c,d){return e({_status:"ERR",_msg:"Server returned code "+b})})})},m=function(a,d){return c(function(c,e){var g;return g=f.apiRoot+("/"+a+"/"+d._id),b({method:"DELETE",url:g}).success(function(a,b,d,f){return angular.isDefined(a._status)&&"OK"===a._status?c(a):e(a)}).error(function(a,b,c,d){return e({_status:"ERR",_msg:"Server returned code "+b})})})},e=function(){function b(b,e){var f;this._listCache={},this._docCache={},this._actives=[],this.tids=[],this.qBusy=c(function(a,b){return a()}),this.apiRoot="/api",f=Primus.connect(b,e),f.on("data",function(b){return function(c){return b.qBusy.then(function(){var e,f;return e=c.collection,"tid"in c&&(f=c.tid,a.call(b.tids,f)>=0)?b.tids.splice(b.tids.indexOf(c.tid),1):(b.invalidateLists(e),"edit"===c.action&&b.invalidateDoc(e,c.id),d.$broadcast("cacheEvent",c),d.$broadcast("socketEvent",c))})}}(this))}return b.prototype._setupCache=function(a){return a in this._listCache||(this._listCache[a]={}),a in this._docCache?void 0:this._docCache[a]={}},b.prototype._isCached=function(a,b,c){var d,e,f;return d=c.fields||{},this._setupCache(a),k(b)?(e=i(d),b._id in this._docCache[a]&&this._docCache[a][b._id].valid&&e in this._docCache[a][b._id]):(f=j(b,c),e=i(d),f in this._listCache[a]&&this._listCache[a][f].valid&&this._listCache[a][f].docs.every(function(a){return a.valid&&e in a}))},b.prototype._getList=function(a,b,c){var d,e,f,h;return d=c.fields||{},this._setupCache(a),k(b)?(e=i(d),[this._getDoc(a,b,d)]):(f=j(b,c),e=i(d),g(function(){var b,c,d,g;for(d=this._listCache[a][f].docs,g=[],b=0,c=d.length;c>b;b++)h=d[b],g.push(h[e]);return g}.call(this)))},b.prototype._getDoc=function(a,b,c){var d,e;return d=c.fields||{},e=i(d),g(this._docCache[a][b._id][e])},b.prototype._cacheList=function(a,b,c,d){var e,f,g;return e=c.fields||{},this._setupCache(a),k(b)?this._cacheDoc(a,d[0],e):(g=j(b,c),f=i(e),g in this._listCache[a]||(this._listCache[a][g]={}),this._listCache[a][g].valid=!0,this._listCache[a][g].docs=[],d.forEach(function(b){return function(d){return b._listCache[a][g].docs.push(b._cacheDoc(a,d,c))}}(this)))},b.prototype._cacheDoc=function(a,b,c){var d,e;return null==c&&(c={}),d=c.fields||{},e=i(d),b._id in this._docCache[a]||(this._docCache[a][b._id]={}),this._docCache[a][b._id].valid=!0,this._docCache[a][b._id][e]=b,this._docCache[a][b._id]},b.prototype.invalidateDoc=function(a,b){return this._setupCache(a),b in this._docCache[a]?this._docCache[a][b].valid=!1:void 0},b.prototype.invalidateLists=function(a){var b,c,d,e;this._setupCache(a),c=this._listCache[a],d=[];for(b in c)e=c[b],d.push(e.valid=!1);return d},b.prototype.find=function(a,b,d,e){var f;return null==b&&(b={}),null==d&&(d={}),null==e&&(e=!1),f=e||!this._isCached(a,b,d)?n(a,b,d).then(function(c){return function(e){return c._cacheList(a,b,d,e._items)}}(this))["catch"](function(a){throw a}):c(function(a){return a()}),f.then(function(c){return function(){return c._getList(a,b,d)}}(this))},b.prototype.findOne=function(a,b,d,e){var f;return null==b&&(b={}),null==d&&(d={}),null==e&&(e=!1),f=e||!this._isCached(a,b,d)?n(a,b,d).then(function(c){return function(e){return c._cacheList(a,b,d,e._items)}}(this))["catch"](function(a){throw a}):c(function(a){return a()}),f.then(function(c){return function(){return c._getList(a,b,d)[0]}}(this))},b.prototype.insert=function(a,b){return this.qBusy=c(function(c){return function(e,f){return c._setupCache(a),o(a,b).then(function(b){var f;return f=b._tid,c.tids.push(f),c._cacheDoc(a,b._item),c.invalidateLists(a),d.$broadcast("cacheEvent",{action:"create",collection:a,id:b._item._id,tid:f}),e(b._item)})["catch"](function(a){return f(a)})}}(this))},b.prototype.update=function(a,b){return this.qBusy=c(function(c){return function(e,f){return c._setupCache(a),p(a,b).then(function(b){var f;return f=b._tid,c.tids.push(f),c._cacheDoc(a,b._item),c.invalidateLists(a),d.$broadcast("cacheEvent",{action:"edit",collection:a,id:b._item._id,tid:f}),e(b._item)})["catch"](function(a){return f(a)})}}(this))},b.prototype.remove=function(a,b){return this.qBusy=c(function(c){return function(e,f){return c._setupCache(a),m(a,b).then(function(f){var g;return g=f._tid,c.tids.push(g),c.invalidateDoc(a,b._id),c.invalidateLists(a),d.$broadcast("cacheEvent",{action:"delete",collection:a,id:b._id,tid:g}),e(null)})["catch"](function(a){return f(a)})}}(this))},b.prototype.setActive=function(a){return this.clearActives(),this.addActive(a)},b.prototype.addActive=function(a){var b,c,d,e;for(e=this._actives,c=0,d=e.length;d>c;c++)if(b=e[c],b===a)return;return this._actives.push(a)},b.prototype.clearActives=function(){return this._actives.splice(0)},b}(),f=new e}])}).call(this),function(){angular.module("flipDoc",["flipCache"]).factory("flipDoc",["$q","flipCache",function(a,b){var c,d,e;return d=function(a){var b,c,e,f;if("object"!=typeof a)return a;if(null===a)return a;if(a instanceof Array)return function(){var b,c,e;for(e=[],b=0,c=a.length;c>b;b++)f=a[b],e.push(d(f));return e}();c={};for(b in a)e=a[b],e instanceof Date?(c[b]=d(e),c[b].__proto__=e.proto):c[b]=d(e);return c},c=function(){function c(a,b){this._id=null,"object"==typeof a?this._extend(d(a)):(this._collection=a,"object"==typeof b?this._extend(b):this._id=b)}return c.prototype._extend=function(a){var b,c,d;c=[];for(b in a)d=a[b],angular.isFunction(d)?c.push(void 0):c.push(this[b]=d);return c},c.prototype._clear=function(){var a,b,c;b=[];for(a in this)c=this[a],angular.isFunction(c)?b.push(void 0):b.push(this[a]=null);return b},c.prototype.$get=function(c){return null==c&&(c=!1),a(function(a){return function(d,e){return b.findOne(a._collection,{_id:a._id},{},c).then(function(b){return a._extend(b),d(a)})["catch"](function(a){return e(a)})}}(this))},c.prototype.$save=function(){return a(function(a){return function(c,d){return a._id?b.update(a._collection,a).then(function(b){return a._extend(b),c(a)})["catch"](function(a){return d(a)}):b.insert(a._collection,a).then(function(b){return a._extend(b),c(a)})["catch"](function(a){return d(a)})}}(this))},c.prototype.$delete=function(){return a(function(a){return function(c,d){return b.remove(a._collection,a).then(function(b){return a._clear(),c()})["catch"](function(a){return d(a)})}}(this))},c.prototype.setActive=function(){return b.setActive(this)},c.prototype.addActive=function(){return b.addActive(this)},c}(),e=function(a,b){return new c(a,b)},e.clearActives=function(){return b.clearActives()},e}])}.call(this),function(){angular.module("flipList",["flipCache","flipDoc"]).factory("flipList",["$q","flipCache","flipDoc",function(a,b,c){var d;return d=function(d){var e;return e=[],e.params={},e.params.collection=d.collection,e.params.filter=d.filter||{},e.params.options=d.options||{},e.params.options.fields=d.fields||{},e.params.options.sort=d.sort||{},e.$get=function(d){return null==d&&(d=!1),a(function(a,f){return b.find(e.params.collection,e.params.filter,e.params.options,d).then(function(b){return e.splice(0,e.length),b.forEach(function(a){return e.push(c(e.params.collection,a))}),a(e)})["catch"](function(a){return f(a)})})},e.setActive=function(){return b.setActive(e)},e.addActive=function(){return b.addActive(e)},e}}])}.call(this);