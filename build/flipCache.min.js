(function(){var a=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};angular.module("flipCache",[]).factory("flipCache",["$http","$q","$rootScope",function(b,c,d){var e,f,g,h,i,j,k,l,m,n;return j=console.log,h=function(a,b){return null==a&&(a={}),null==b&&(b={}),JSON.stringify({query:a,options:b})},g=function(a){return null==a&&(a={}),JSON.stringify(a)},i=function(a){return null==a&&(a={}),1===Object.keys(a).length&&"_id"===Object.keys(a)[0]&&"number"==typeof a._id},f=function(a){var b,c,d,e;if("object"!=typeof a)return a;if(null===a)return a;if(a instanceof Array)return function(){var b,c,d;for(d=[],b=0,c=a.length;c>b;b++)e=a[b],d.push(f(e));return d}();c={};for(b in a)d=a[b],d instanceof Date?(c[b]=f(d),c[b].__proto__=d.proto):c[b]=f(d);return c},l=function(a,d,e){return c(function(c,f){var g,h;return h="/api/"+a,g={},Object.keys(d).length>0&&(g.q=JSON.stringify(d)),Object.keys(e).length>0&&(g.fields=JSON.stringify(e)),b({method:"GET",url:h,params:g}).success(function(a,b,d,e){return angular.isDefined(a._status)&&"OK"===a._status&&angular.isDefined(a._items)?c(a):f(a)}).error(function(a,b,c,d){return f({_status:"ERR",_msg:"Server returned code "+b})})})},m=function(a,d){return c(function(c,e){var f;return f="/api/"+a,b({method:"POST",url:f,data:d}).success(function(a,b,d,f){return angular.isDefined(a._status)&&"OK"===a._status&&angular.isDefined(a._item)?c(a):e(a)}).error(function(a,b,c,d){return e({_status:"ERR",_msg:"Server returned code "+b})})})},n=function(a,d){return c(function(c,e){var f;return f="/api/"+a+"/"+d._id,b({method:"PUT",url:f,data:d}).success(function(a,b,d,f){return angular.isDefined(a._status)&&"OK"===a._status&&angular.isDefined(a._item)?c(a):e(a)}).error(function(a,b,c,d){return e({_status:"ERR",_msg:"Server returned code "+b})})})},k=function(a,d){return c(function(c,e){var f;return f="/api/"+a+"/"+d._id,b({method:"DELETE",url:f}).success(function(a,b,d,f){return angular.isDefined(a._status)&&"OK"===a._status?c():e(a)}).error(function(a,b,c,d){return e({_status:"ERR",_msg:"Server returned code "+b})})})},new(e=function(){function b(){var b;this._listCache={},this._docCache={},this._actives=[],this._tids=[],b=Primus.connect(),b.on("data",function(b){return function(c){var e;if(e=c.tid,a.call(b._tids,e)>=0)return b._tids.splice(b._tids.indexOf(c.tid),1);switch(c.action){case"create":b._resetList(c.collection);break;case"delete":b._resetList(c.collection);break;case"edit":b._resetDoc(c.collection,c.id)}return d.$broadcast("socketEvent",c)}}(this))}return b.prototype._setupCache=function(a){return a in this._listCache||(this._listCache[a]={}),a in this._docCache?void 0:this._docCache[a]={}},b.prototype._isCached=function(a,b,c,d){var e,f;return this._setupCache(a),i(b)?(e=g(d),b._id in this._docCache[a]&&this._docCache[a][b._id].valid&&e in this._docCache[a][b._id]):(f=h(b,c),e=g(d),f in this._listCache[a]&&this._listCache[a][f].valid&&this._listCache[a][f].docs.every(function(a){return a.valid&&e in a}))},b.prototype._getList=function(a,b,c,d){var e,j,k;return this._setupCache(a),i(b)?(e=g(d),[this._getDoc(a,b,d)]):(j=h(b,c),e=g(d),f(function(){var b,c,d,f;for(d=this._listCache[a][j].docs,f=[],b=0,c=d.length;c>b;b++)k=d[b],f.push(k[e]);return f}.call(this)))},b.prototype._getDoc=function(a,b,c){var d;return d=g(c),f(this._docCache[a][b._id][d])},b.prototype._cacheList=function(a,b,c,d,e){var f,j;return this._setupCache(a),i(b)?this._cacheDoc(a,e[0],d):(j=h(b,c),f=g(d),j in this._listCache[a]||(this._listCache[a][j]={}),this._listCache[a][j].valid=!0,this._listCache[a][j].docs=[],e.forEach(function(b){return function(c){return b._listCache[a][j].docs.push(b._cacheDoc(a,c,d))}}(this)))},b.prototype._cacheDoc=function(a,b,c){var d;return d=g(c),b._id in this._docCache[a]||(this._docCache[a][b._id]={}),this._docCache[a][b._id].valid=!0,this._docCache[a][b._id][d]=b,this._docCache[a][b._id]},b.prototype._resetList=function(a){return this.invalidateLists(a),this._actives.forEach(function(b){return"collection"in b&&b.collection===a?b.$get():void 0})},b.prototype._resetDoc=function(a,b){return this.invalidateDoc(a,b),this._refreshActivesDoc(a,b)},b.prototype._refreshActivesDoc=function(a,b){return this._actives.forEach(function(c){return"_collection"in c&&c._collection===a&&c._id===b?c.$get():void 0})},b.prototype.invalidateDoc=function(a,b){return this._setupCache(a),b in this._docCache[a]?this._docCache[a][b].valid=!1:void 0},b.prototype.invalidateLists=function(a){var b,c,d,e;this._setupCache(a),c=this._listCache[a],d=[];for(b in c)e=c[b],d.push(e.valid=!1);return d},b.prototype.find=function(a,b,d,e){var f;return null==b&&(b={}),null==d&&(d={}),null==e&&(e={}),f=this._isCached(a,b,d,e)?c(function(a){return a()}):l(a,b,e).then(function(c){return function(f){return c._cacheList(a,b,d,e,f._items)}}(this))["catch"](function(a){throw a}),f.then(function(c){return function(){return c._getList(a,b,d,e)}}(this))},b.prototype.findOne=function(a,b,d,e){var f;return null==b&&(b={}),null==d&&(d={}),null==e&&(e={}),f=this._isCached(a,b,d,e)?c(function(a){return a()}):l(a,b,e).then(function(c){return function(f){return c._cacheList(a,b,d,e,f._items)}}(this))["catch"](function(a){throw a}),f.then(function(c){return function(){return c._getList(a,b,d,e)[0]}}(this))},b.prototype.insert=function(a,b){return this._setupCache(a),m(a,b).then(function(b){return function(c){return b._cacheDoc(a,c._item),c._item}}(this))["catch"](function(a){throw a})},b.prototype.update=function(a,b){return this._setupCache(a),n(a,b).then(function(b){return function(c){return b._cacheDoc(a,c._item),b._tids.push(c._tid),b._refreshActivesDoc(a,c._item._id),c._item}}(this))["catch"](function(a){throw a})},b.prototype.remove=function(a,b){return this._setupCache(a),k(a,b).then(function(c){return function(d){return c.invalidateDoc(a,b._id),null}}(this))["catch"](function(a){throw a})},b.prototype.setActive=function(a){return this.clearActives(),this.addActive(a)},b.prototype.addActive=function(a){var b,c,d,e;for(e=this._actives,c=0,d=e.length;d>c;c++)if(b=e[c],b===a)return;return this._actives.push(a)},b.prototype.clearActives=function(){return this._actives.splice(0)},b}())}])}).call(this),function(){angular.module("flipDoc",["flipCache"]).factory("flipDoc",["$q","flipCache",function(a,b){var c,d;return c=function(){function c(a,b){this._id=null,"object"==typeof a?this._extend(a):(this._collection=a,"object"==typeof b?this._extend(b):this._id=b)}return c.prototype._extend=function(a){var b,c,d;c=[];for(b in a)d=a[b],angular.isFunction(d)?c.push(void 0):c.push(this[b]=d);return c},c.prototype._clear=function(){var a,b,c;b=[];for(a in this)c=this[a],angular.isFunction(c)?b.push(void 0):b.push(this[a]=null);return b},c.prototype.$get=function(){return a(function(a){return function(c,d){return b.findOne(a._collection,{_id:a._id}).then(function(b){return a._extend(b),c(a)})["catch"](function(a){return d(a)})}}(this))},c.prototype.$save=function(){return a(function(a){return function(c,d){return a._id?b.update(a._collection,a).then(function(b){return a._extend(b),c(a)})["catch"](function(a){return d(a)}):b.insert(a._collection,a).then(function(b){return a._extend(b),c(a)})["catch"](function(a){return d(a)})}}(this))},c.prototype.$delete=function(){return a(function(a){return function(c,d){return b.remove(a._collection,a).then(function(b){return a._clear(),c()})["catch"](function(a){return d(a)})}}(this))},c.prototype.setActive=function(){return b.setActive(this)},c.prototype.addActive=function(){return b.addActive(this)},c}(),d=function(a,b){return new c(a,b)},d.clearActives=function(){return b.clearActives()},d}])}.call(this),function(){angular.module("flipList",["flipCache","flipDoc"]).factory("flipList",["$q","flipCache","flipDoc",function(a,b,c){var d;return d=function(d){var e;return e=[],e.collection=d.collection,e.filter=d.filter||{},e.options=d.options||{},e.fields=d.fields||{},e.$get=function(){return a(function(a,d){return b.find(e.collection,e.filter,e.options,e.fields).then(function(b){var d,f,g;for(e.splice(0,e.length),d=0,f=b.length;f>d;d++)g=b[d],e.push(c(e.collection,g));return a(e)})["catch"](function(a){return d(a)})})},e.setActive=function(){return b.setActive(e)},e.addActive=function(){return b.addActive(e)},e},d.clearActives=function(){return b.clearActives()},d}])}.call(this);